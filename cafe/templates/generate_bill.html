{% extends 'base.html' %}

{% block title %}Bill{% endblock title %}
<meta name="description"
    content="Invoice {{ inv_id }} for {{ name }} â€“ View customer bill details, total charges, and itemized purchases.">
{%block body%}

{% for message in messages %}
<div class="alert alert-success alert-dismissable fade show" role="alert">
    <strong>{{message}}</strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}

<div class="container col-md-6">
    <div style="display:grid;place-content:center; padding-top:50px">
        <h3>Bill No : {{inv_id}} </h3>
        {% if name != "Unknown" %}
        <h4>Name: {{ name }}</h4>
        <h4>Phone: {{ phone }}</h4>
        {% endif %}
    </div>
    <table class="table table-bordered border-dark">
        <thead>
            <tr>
                <th>Item name</th>
                <th>Qty</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for key, value in order_dict.items %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ value.0 }}</td>
                <td>{{ value.1 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3 style="display:grid ;place-items:end">Bill Total: {{ bill_total }}</h3>
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button onclick="printBill()" class="btn btn-primary">Print Bill</button>
    </div>
</div>

{%endblock body%}

{% block js %}
<script>
    /* global window, history, sessionStorage, location */
    function printBill() {
        window.print();
    }
    
    // Check if this bill was already generated in this session
    const billKey = 'bill_generated_{{ inv_id }}';
    const currentPath = window.location.pathname;
    
    if (sessionStorage.getItem(billKey) === currentPath) {
        // Bill already generated, redirect to prevent duplicate
        window.location.href = '/menu';
    } else {
        // Mark this bill as generated
        sessionStorage.setItem(billKey, currentPath);
    }
    
    // Prevent refresh from creating new bill
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }
    
    // Disable F5 and Ctrl+R
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Detect hard refresh and redirect
    window.addEventListener('beforeunload', function() {
        sessionStorage.setItem('hard_refresh_' + billKey, 'true');
    });
    
    if (sessionStorage.getItem('hard_refresh_' + billKey) === 'true') {
        sessionStorage.removeItem('hard_refresh_' + billKey);
        window.location.href = '/menu';
    }
</script>

{%endblock js%}