{% extends 'base.html' %}

{% block title %}Cart{% endblock title %}

{%block body%}

{% for message in messages %}
<div class="alert alert-success alert-dismissable fade show" role="alert">
    <strong>{{message}}</strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}

<!-- <h1>Cart Page</h1> -->

<div class="container py-2 ">
    <h2>Review your order</h2>
    <div class='col c_cart'>
        <form method='post' action='/cart'>
            {% csrf_token %}
            <input type='hidden' name="items_json" id="itemsjson">
            <input type="hidden" id="tableValueInput" name='table_value' >
            <div class='my-4'>

                <ul class="list-group " id='items'>

                </ul>
                <ul class="list-group" style="padding:10px 15px 10px">
                  <li class="d-flex justify-content-end align-items-center">
                      <strong>
                          Total = Â£
                          <input type="hidden" name="price" id="price_input">
                          <span id="total">0</span>
                      </strong>
                  </li>
                </ul>

            </div>
            <div class="d-flex flex-column flex-md-row gap-2">
                <button type="button" class="btn btn-primary clear_cart">Clear cart</button>
                <a href='/' class="btn btn-primary">Add more items</a>
                <button type='submit' class="btn btn-primary">Place order</button>
            </div>
        </form>
    </div>
</div>

{% endblock body %}

{% block js %}

<script>
/* global $, document, localStorage */
    $(document).ready(function() {
    // Load cart from localStorage
    var cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};

    // Render cart items
    $('#items').empty();
    if ($.isEmptyObject(cart)){
      let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
        Please add items to cart
        <span class="badge bg-primary rounded-pill"></span>
      </li>`;
      $('#items').append(mystr);
      $('#price_input').val(0);
    } else {
      let total_price = 0;
      for (let item in cart){
        let name = cart[item][1];
        let qty = cart[item][0];
        let item_price = cart[item][2];
        total_price += qty * item_price;
        let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
          ${name}
          <span class="badge bg-primary rounded-pill">${qty}</span>
        </li>`;
        $('#items').append(mystr);
      }
      $('#total').text(total_price);
      $('#price_input').val(total_price);
    }

    // Set hidden fields
    $('#itemsjson').val(JSON.stringify(cart));
    $('#tableValueInput').val(localStorage.getItem('tableValue') || '');

    // On form submit, update hidden fields and clear cart after order placed
    $('form').on('submit', function () {
      var cart = localStorage.getItem('cart') || '{}';
      var tableValue = localStorage.getItem('tableValue') || '';
      var total = 0;
      var cartObj = JSON.parse(cart);
      for (var key in cartObj) {
        total += cartObj[key][0] * cartObj[key][2];
      }
      $('#itemsjson').val(cart);
      $('#tableValueInput').val(tableValue);
      $('#price_input').val(total);

      // Clear cart after order placed
      localStorage.removeItem('cart');
    });

    $('.clear_cart').click(function (event) {
      event.preventDefault();
      localStorage.removeItem('cart');
      $('#items').empty();
      let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
        Your cart has been cleared. Please add items to order.
        <span class="badge bg-primary rounded-pill"></span>
      </li>`;
      $('#items').append(mystr);
      $('#price_input').val(0);
      $('#total').text(0);
      $('#itemsjson').val('{}');
    });
  });
</script>

{% endblock js %}