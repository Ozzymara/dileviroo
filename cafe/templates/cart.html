{% extends 'base.html' %}

{% block title %}ðŸ›’ Cart{% endblock title %}

{%block body%}

{% for message in messages %}
<div class="alert alert-success alert-dismissable fade show" role="alert">
    <strong>{{message}}</strong>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}

<!-- Add the main h1 header here -->
<div class="container text-center my-4">
    <h1>ðŸ›’ Cart</h1>
</div>

<div class="container py-2 ">
    <!-- Change this to h2 for proper hierarchy -->
    <h2>Review your order</h2>
    <div class='col c_cart'>
        <form method='post' action='/cart'>
            {% csrf_token %}
            <input type='hidden' name="items_json" id="itemsjson">
            <input type="hidden" id="tableValueInput" name='table_value' >
            <div class='my-4'>

                <ul class="list-group " id='items'>

                </ul>
                <ul class="list-group" style="padding:10px 15px 10px">
                  <li class="d-flex justify-content-end align-items-center">
                      <strong>
                          Total = Â£
                          <input type="hidden" name="price" id="price_input">
                          <span id="total">0</span>
                      </strong>
                  </li>
                </ul>

            </div>
            <div class="d-flex flex-column flex-md-row gap-2">
                <button type="button" class="btn btn-primary clear_cart">Clear cart</button>
                <a href='/' class="btn btn-primary">Add more items</a>
                <button type='submit' class="btn btn-primary">Place order</button>
            </div>
        </form>
    </div>
</div>

{% endblock body %}

{% block js %}

<script>
  /* global setTimeout, console */
/* global $, document, localStorage */
    $(document).ready(function() {
    // Load cart from localStorage
    var cart = localStorage.getItem('cart') ? JSON.parse(localStorage.getItem('cart')) : {};

    // Render cart items
    $('#items').empty();
    if ($.isEmptyObject(cart)){
      let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
        Please add items to cart
        <span class="badge bg-primary rounded-pill"></span>
      </li>`;
      $('#items').append(mystr);
      $('#price_input').val(0);
    } else {
      let total_price = 0;
      for (let item in cart){
        let name = cart[item][1];
        let qty = cart[item][0];
        let item_price = cart[item][2];
        total_price += qty * item_price;
        let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
          ${name}
          <span class="badge bg-primary rounded-pill">${qty}</span>
        </li>`;
        $('#items').append(mystr);
      }
      $('#total').text(total_price);
      $('#price_input').val(total_price);
    }

    // Set hidden fields
    $('#itemsjson').val(JSON.stringify(cart));
    $('#tableValueInput').val(localStorage.getItem('tableValue') || '');

    // Place order with validation and confirmation
    $('form').on('submit', function (event) {
      event.preventDefault(); // Prevent default form submission
      
      var cart = localStorage.getItem('cart') || '{}';
      var cartObj = JSON.parse(cart);
      var tableValue = localStorage.getItem('tableValue') || '';
      
      // Check if cart is empty or has no items
      if ($.isEmptyObject(cartObj) || Object.keys(cartObj).length === 0) {
        showErrorMessage('To place an order, please add items to cart.');
        return false;
      }
      
      // Check if total quantity is 0
      var totalQuantity = 0;
      for (var key in cartObj) {
        totalQuantity += cartObj[key][0];
      }
      
      if (totalQuantity === 0) {
        showErrorMessage('To place an order, please add items to cart.');
        return false;
      }
      
      // Confirmation dialog for placing order
      if (confirm('Are you sure you want to place this order? Please review your items and total.')) {
        var total = 0;
        for (var key in cartObj) {
          total += cartObj[key][0] * cartObj[key][2];
        }
        
        $('#itemsjson').val(cart);
        $('#tableValueInput').val(tableValue);
        $('#price_input').val(total);

        // Clear cart after order confirmation
        localStorage.removeItem('cart');
        
        // Submit the form
        this.submit();
      }
    });

    // Clear cart with confirmation
    $('.clear_cart').click(function (event) {
      event.preventDefault();
      
      var cart = localStorage.getItem('cart') || '{}';
      var cartObj = JSON.parse(cart);
      
      // Check if cart is already empty
      if ($.isEmptyObject(cartObj) || Object.keys(cartObj).length === 0) {
        showWarningMessage('Your cart is already empty.');
        return false;
      }
      
      // Confirmation dialog for clearing cart
      if (confirm('Are you sure you want to clear your cart? All items will be removed.')) {
        localStorage.removeItem('cart');
        $('#items').empty();
        let mystr = `<li class="list-group-item d-flex justify-content-between align-items-center">
          Your cart has been cleared. Please add items to order.
          <span class="badge bg-primary rounded-pill"></span>
        </li>`;
        $('#items').append(mystr);
        $('#price_input').val(0);
        $('#total').text(0);
        $('#itemsjson').val('{}');
        
        // Update cart badge in navbar
        document.getElementById('cart').innerHTML = 0;
        
        // Show success message
        showSuccessMessage('Cart has been cleared successfully.');
      }
    });

    // Function to show error messages (like Django messages.error)
    function showErrorMessage(message) {
      const alertHtml = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>${message}</strong>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      // Remove existing alerts
      $('.alert').remove();
      
      // Add new alert at the top of the page
      $('main .container:first').prepend(alertHtml);
      
      // Auto-dismiss after 5 seconds
      setTimeout(function() {
        $('.alert-danger').fadeOut();
      }, 5000);
    }

    // Function to show success messages (like Django messages.success)
    function showSuccessMessage(message) {
      const alertHtml = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <strong>${message}</strong>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      // Remove existing alerts
      $('.alert').remove();
      
      // Add new alert at the top of the page
      $('main .container:first').prepend(alertHtml);
      
      // Auto-dismiss after 3 seconds
      setTimeout(function() {
        $('.alert-success').fadeOut();
      }, 3000);
    }

    // Function to show warning messages (like Django messages.warning)
    function showWarningMessage(message) {
      const alertHtml = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <strong>${message}</strong>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      // Remove existing alerts
      $('.alert').remove();
      
      // Add new alert at the top of the page
      $('main .container:first').prepend(alertHtml);
      
      // Auto-dismiss after 4 seconds
      setTimeout(function() {
        $('.alert-warning').fadeOut();
      }, 4000);
    }
  });
</script>

{% endblock js %}